<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Miels">
    <title>Miels Du Soir</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,600&family=Inter:wght@300;400;600;700&display=swap');
        
        :root {
            --bg-cream: #FBF9F4;
            --btn-taupe: #B7B4AF;
            --text-dark: #1A1A1A;
        }

        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-cream);
            color: var(--text-dark);
            margin: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }
        
        .font-serif { font-family: 'Cormorant Garamond', serif; }
        
        /* Ajustements Safe Areas iPhone 16 */
        .safe-pt { padding-top: calc(env(safe-area-inset-top) + 12px); }
        .safe-pb { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }

        /* Carte d'écriture style photo */
        .input-card {
            background: white;
            border-radius: 40px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.02);
            transition: transform 0.3s ease;
        }

        /* Toggle Navigation style photo */
        .nav-toggle {
            background: #F2F0EB;
            border-radius: 50px;
            padding: 4px;
        }
        .nav-btn {
            padding: 8px 20px;
            border-radius: 40px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
        }
        .nav-btn.active {
            background: white;
            color: #1a1a1a;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .nav-btn.inactive {
            color: #BCB9B4;
        }

        /* Bouton "Faire couler le miel" */
        .btn-pour {
            background-color: var(--btn-taupe);
            border-radius: 30px;
            color: white;
            font-weight: 700;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        .btn-pour:active { transform: scale(0.97); opacity: 0.9; }

        /* Sélecteurs épurés */
        .select-custom {
            background-color: white;
            border-radius: 20px;
            padding: 16px 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 18px center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [view, setView] = useState('atelier');
            const [apiKey, setApiKey] = useState(localStorage.getItem('miels_key') || '');
            const [showSettings, setShowSettings] = useState(!localStorage.getItem('miels_key'));
            const [topic, setTopic] = useState('');
            const [format, setFormat] = useState('POÈMES');
            const [style, setStyle] = useState('RUPI KAUR');
            const [tone, setTone] = useState('NOSTALGIQUE');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [saved, setSaved] = useState(JSON.parse(localStorage.getItem('miels_archive') || '[]'));

            // Données complètes
            const formats = ["POÈMES", "PROSES", "HAÏKU"];
            const poets = ["RUPI KAUR", "BAUDELAIRE", "BOBIN", "RIMBAUD", "ÉLUARD", "GRAND CORPS MALADE", "DARWICH", "DICKINSON", "CÉCILE COULON", "ANDRÉE CHEDID", "POÉSIE DE RUE", "HAÏKU ZEN"];
            const tones = ["NOSTALGIQUE", "TOXIQUE COOL", "SOLAIRE", "MÉLANCOLIQUE", "ÉPERDU", "SENSUEL", "MYSTIQUE", "AMOUREUX", "RÊVEUR", "CYNIQUE", "LUMINEUX", "GOTHIQUE"];

            const saveApiKey = (val) => {
                localStorage.setItem('miels_key', val.trim());
                setApiKey(val.trim());
                setShowSettings(false);
            };

            const generate = async () => {
                if (!topic.trim()) return;
                setLoading(true);
                try {
                    const prompt = `Tu es "Miels". Rédige un écrit poétique. 
                    Format: ${format}. Style: ${style}. Ton: ${tone}. 
                    Sois bref et percutant. Sépare par des doubles sauts de ligne si nécessaire.
                    Réponds UNIQUEMENT en JSON: {"title": "Titre", "content": "Le texte ici..."}`;
                    
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Sujet : ${topic}\n\n${prompt}` }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    const data = await res.json();
                    const content = JSON.parse(data.candidates[0].content.parts[0].text);
                    setResult(content);
                } catch (e) { alert("Erreur de connexion API."); }
                setLoading(false);
            };

            const archivePoem = () => {
                const newArchive = [{...result, id: Date.now(), date: new Date().toLocaleDateString()}, ...saved];
                setSaved(newArchive);
                localStorage.setItem('miels_archive', JSON.stringify(newArchive));
                setResult(null);
                setTopic('');
                alert("Poème archivé.");
            };

            const randomPrompt = () => {
                const ideas = ["L'odeur de la pluie sur le bitume", "Un dernier regard sur le quai", "Le silence d'un message non envoyé", "Une cicatrice qui ne fait plus mal", "L'instant précis où l'on s'oublie"];
                setTopic(ideas[Math.floor(Math.random() * ideas.length)]);
            };

            return (
                <div className="flex flex-col min-h-[100dvh] max-w-lg mx-auto overflow-hidden">
                    
                    {/* Ecran de configuration Clé API */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[100] bg-[#FBF9F4] flex flex-col items-center justify-center p-10 text-center space-y-8 animate-fade">
                            <div className="w-16 h-16 bg-black rounded-full flex items-center justify-center text-white shadow-xl">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3-3.5 3.5z"/></svg>
                            </div>
                            <div className="space-y-2">
                                <h2 className="font-serif text-3xl italic">Clé API requise</h2>
                                <p className="text-[10px] text-stone-400 uppercase font-bold tracking-[0.2em]">Pour animer votre plume numérique</p>
                            </div>
                            <input 
                                type="password" 
                                placeholder="Coller votre clé Gemini ici"
                                id="api_field"
                                className="w-full bg-white rounded-3xl p-5 text-center text-sm shadow-sm outline-none border border-stone-100"
                            />
                            <button onClick={() => saveApiKey(document.getElementById('api_field').value)} className="w-full py-5 btn-pour shadow-lg">Activer</button>
                        </div>
                    )}

                    {/* Header conforme à l'image */}
                    <header className="safe-pt px-8 py-4 flex justify-between items-center bg-[#FBF9F4]/80 backdrop-blur-lg sticky top-0 z-40">
                        <div className="flex items-center gap-3" onClick={() => {setResult(null); setView('atelier');}}>
                            <div className="w-10 h-10 bg-black rounded-full flex items-center justify-center text-white shadow-md">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"/><line x1="16" y1="8" x2="2" y2="22"/></svg>
                            </div>
                            <span className="font-serif font-bold text-2xl italic tracking-tight">Miels</span>
                        </div>
                        <div className="nav-toggle flex">
                            <button onClick={() => setView('atelier')} className={`nav-btn ${view==='atelier'?'active':'inactive'}`}>Atelier</button>
                            <button onClick={() => setView('brouillons')} className={`nav-btn ${view==='brouillons'?'active':'inactive'}`}>Carnet</button>
                        </div>
                    </header>

                    {/* Zone de contenu principale */}
                    <main className="flex-1 px-8 py-6 overflow-y-auto no-scrollbar">
                        {view === 'atelier' ? (
                            <div className="space-y-10 animate-fade">
                                {!result || loading ? (
                                    <div className="space-y-8">
                                        <div className="space-y-1">
                                            <h2 className="text-[44px] font-serif leading-tight">L'encre du crépuscule.</h2>
                                            <p className="text-[#BCB9B4] text-[16px] font-serif italic">Écrivez ce que le silence ne dit pas.</p>
                                        </div>

                                        {/* Input blanc style capture */}
                                        <div className="input-card relative p-10 h-64 border border-white">
                                            <textarea 
                                                value={topic}
                                                onChange={(e) => setTopic(e.target.value)}
                                                placeholder="Un sentiment, un lieu, un oubli..."
                                                className="w-full h-full bg-transparent border-none outline-none resize-none text-[20px] font-serif placeholder:text-[#BCB9B4] leading-relaxed"
                                            />
                                            <button onClick={randomPrompt} className="absolute bottom-8 right-10 text-[#BCB9B4] hover:text-black active:scale-90 transition-all">
                                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M7 7h.01"/><path d="M17 7h.01"/><path d="M7 17h.01"/><path d="M17 17h.01"/><path d="M12 12h.01"/></svg>
                                            </button>
                                        </div>

                                        {/* Sélecteurs styles et tonalités */}
                                        <div className="space-y-4">
                                            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                                {formats.map(f => (
                                                    <button key={f} onClick={() => setFormat(f)} className={`px-6 py-3 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all ${format === f ? 'bg-black text-white' : 'bg-white text-[#BCB9B4]'}`}>{f}</button>
                                                ))}
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <select value={style} onChange={(e) => setStyle(e.target.value)} className="select-custom">
                                                    {poets.map(p => <option key={p} value={p}>{p}</option>)}
                                                </select>
                                                <select value={tone} onChange={(e) => setTone(e.target.value)} className="select-custom">
                                                    {tones.map(t => <option key={t} value={t}>{t}</option>)}
                                                </select>
                                            </div>
                                        </div>

                                        <button 
                                            onClick={generate}
                                            disabled={loading || !topic.trim()}
                                            className="w-full py-8 btn-pour shadow-lg disabled:opacity-40"
                                        >
                                            {loading ? "Infusion..." : "Faire couler le miel"}
                                        </button>
                                    </div>
                                ) : (
                                    /* Résultat généré */
                                    <div className="space-y-8 animate-fade pb-10">
                                        <div className="bg-white rounded-[40px] p-12 shadow-xl min-h-[450px] flex flex-col justify-center text-center relative overflow-hidden">
                                            <div className="absolute inset-0 opacity-[0.04] pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/natural-paper.png')]"></div>
                                            <div className="relative z-10 space-y-8 overflow-y-auto max-h-[380px] no-scrollbar px-2">
                                                <h3 className="text-sm font-serif italic text-[#BCB9B4] uppercase tracking-[0.3em]">{result.title}</h3>
                                                <p className="text-[26px] font-serif leading-relaxed italic whitespace-pre-line text-stone-800">
                                                    {result.content}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex gap-4">
                                            <button onClick={() => setResult(null)} className="flex-1 py-6 rounded-full border border-stone-200 text-[10px] font-bold uppercase tracking-widest text-stone-400">Nouvelle plume</button>
                                            <button onClick={archivePoem} className="flex-1 py-6 bg-black text-white rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg">Sauvegarder</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            /* Liste des brouillons */
                            <div className="space-y-6 animate-fade pb-24">
                                <h2 className="text-3xl font-serif italic mb-8">Carnet d'archives</h2>
                                {saved.length === 0 ? <p className="text-stone-300 italic text-center py-20">Rien n'a encore été écrit.</p> : 
                                    saved.map(item => (
                                        <div key={item.id} className="bg-white rounded-[35px] p-8 shadow-sm border border-white active:scale-95 transition-all" onClick={() => {setResult(item); setView('atelier');}}>
                                            <div className="flex justify-between items-center mb-3">
                                                <span className="text-[9px] font-bold text-[#BCB9B4] uppercase tracking-widest">{item.date}</span>
                                                <button onClick={(e) => { e.stopPropagation(); setSaved(saved.filter(i => i.id !== item.id)); }} className="text-stone-100 hover:text-red-400"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                                            </div>
                                            <h3 className="font-serif text-xl mb-2 italic">{item.title}</h3>
                                            <p className="text-stone-400 text-[13px] italic line-clamp-2 leading-relaxed">{item.content}</p>
                                        </div>
                                    ))
                                }
                            </div>
                        )}
                    </main>

                    {/* Zone de confort bas iPhone 16 */}
                    <footer className="safe-pb h-2 bg-transparent"></footer>
                </div>
            );
        };

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
    </script>
</body>
</html>

